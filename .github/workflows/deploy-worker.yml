name: Deploy Cloudflare Worker

on:
  push:
    branches: [ main ]
    paths:
      - 'cf-worker/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cf-worker
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm i -g wrangler

      - name: Auth check
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: wrangler whoami || true

      - name: Ensure KV namespace
        id: kv
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          set -e
          echo "Checking KV namespace binding in wrangler.toml"
          KV_ID=$(awk '/\[\[kv_namespaces\]\]/{f=1} f&&/id = /{gsub(/\"/,"",$3); print $3; exit}' wrangler.toml)
          if [ -z "$KV_ID" ] || [ "$KV_ID" = "" ]; then
            echo "No KV id set; creating namespace ASSESS_KV"
            OUT=$(wrangler kv:namespace create ASSESS_KV --binding=ASSESS_KV --json)
            ID=$(echo "$OUT" | jq -r '.id')
            if [ -z "$ID" ] || [ "$ID" = "null" ]; then echo "Failed to create KV namespace"; exit 1; fi
            echo "Created KV id: $ID"
            # Replace id line in wrangler.toml
            awk -v id="$ID" 'BEGIN{printed=0} {print} /\[\[kv_namespaces\]\]/{getline; sub(/id = ".*"/, "id = \"" id "\""); print; printed=1} END{if(!printed) exit 1}' wrangler.toml > wrangler.toml.tmp && mv wrangler.toml.tmp wrangler.toml
          else
            echo "KV id already set: $KV_ID"
          fi
      - name: Publish Worker
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: wrangler publish

